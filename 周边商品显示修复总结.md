# å‘¨è¾¹å•†å“æ˜¾ç¤ºä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç”Ÿæˆçš„å‘¨è¾¹å•†å“åº”è¯¥æ˜¾ç¤ºåœ¨å·¥ä½œåŠçš„å‘¨è¾¹å•†å“åˆ—è¡¨ä¸­ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨ä»»åŠ¡åˆ—è¡¨é¡µé¢ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### å‘ç°çš„é—®é¢˜
1. **ä»»åŠ¡å®Œæˆä½†ä¸æ˜¾ç¤º**: ä»»åŠ¡åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º"å·²å®Œæˆ"ï¼Œä½†å·¥ä½œåŠçš„å‘¨è¾¹å•†å“åŒºåŸŸä»ç„¶æ˜¯ç©ºçš„
2. **æ•°æ®æ›´æ–°ç¼ºå¤±**: ä»»åŠ¡å®Œæˆåæ²¡æœ‰æ›´æ–°è§’è‰²çš„ `merchandise_urls` å­—æ®µ
3. **ç•Œé¢æ•°æ®ä¸åŒæ­¥**: IPDetail ç»„ä»¶ä½¿ç”¨çš„æ˜¯ props ä¸­çš„æ—§æ•°æ®ï¼Œæ²¡æœ‰è·å–æœ€æ–°çŠ¶æ€

### æŠ€æœ¯æ ¹å› 
1. **ç¼ºå°‘è§’è‰²æ•°æ®æ›´æ–°**: ä»»åŠ¡å®Œæˆæ—¶åªæ›´æ–°äº† `generation_tasks` è¡¨ï¼Œæ²¡æœ‰æ›´æ–° `user_ip_characters` è¡¨çš„ `merchandise_urls` å­—æ®µ
2. **ç•Œé¢æ•°æ®æºé—®é¢˜**: IPDetail ç»„ä»¶ä½¿ç”¨ `ipCharacter.merchandise_urls`ï¼ˆæ¥è‡ª propsï¼‰ï¼Œè€Œä¸æ˜¯æœ€æ–°çš„æ•°æ®åº“çŠ¶æ€
3. **çŠ¶æ€åŒæ­¥ç¼ºå¤±**: æ²¡æœ‰åœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ›´æ–°è§’è‰²çš„ `merchandise_task_status`

## ğŸ› ï¸ å®æ–½çš„ä¿®å¤

### 1. âœ… ä»»åŠ¡å®Œæˆæ—¶æ›´æ–°è§’è‰²æ•°æ®
**æ–‡ä»¶**: `src/app/api/ip/[id]/generate-selected/route.ts`

**ä¿®å¤å†…å®¹**:
```typescript
// ä»»åŠ¡å®Œæˆåæ›´æ–°è§’è‰²çš„å‘¨è¾¹å•†å“URLs
try {
  // è·å–å½“å‰çš„å‘¨è¾¹å•†å“URLs
  const { data: currentCharacter } = await supabase
    .from('user_ip_characters')
    .select('merchandise_urls')
    .eq('id', characterId)
    .single();

  // æ›´æ–°å‘¨è¾¹å•†å“URLs
  const existingUrls = currentCharacter?.merchandise_urls || {};
  const newUrls = { ...existingUrls, [itemType]: mockResultUrl };

  await supabase
    .from('user_ip_characters')
    .update({
      merchandise_urls: newUrls,
      updated_at: new Date().toISOString()
    })
    .eq('id', characterId);
} catch (error) {
  console.error('æ›´æ–°è§’è‰²ä¿¡æ¯æ—¶å‡ºé”™:', error);
}
```

### 2. âœ… æ‰¹æ¬¡å®ŒæˆçŠ¶æ€æ£€æŸ¥
**æ–‡ä»¶**: `src/app/api/ip/[id]/generate-selected/route.ts`

**ä¿®å¤å†…å®¹**:
```typescript
// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–°è§’è‰²çŠ¶æ€
setTimeout(async () => {
  const { data: batchTasks } = await supabase
    .from('generation_tasks')
    .select('status')
    .eq('batch_id', batchId);

  const allCompleted = batchTasks?.every(task => 
    task.status === 'completed' || task.status === 'failed'
  );

  if (allCompleted) {
    await supabase
      .from('user_ip_characters')
      .update({ 
        merchandise_task_status: 'completed',
        updated_at: new Date().toISOString()
      })
      .eq('id', characterId);
  }
}, maxProcessingTime + 2000);
```

### 3. âœ… ç•Œé¢æ•°æ®æºä¿®å¤
**æ–‡ä»¶**: `src/components/IPDetail.tsx`

**ä¿®å¤å†…å®¹**:
```typescript
// ä½¿ç”¨æœ€æ–°çš„è§’è‰²çŠ¶æ€æ•°æ®ï¼Œå¦‚æœå¯ç”¨çš„è¯
const currentCharacterData = characterStatus || ipCharacter;
const merchandiseItems = currentCharacterData.merchandise_urls ? 
  Object.entries(currentCharacterData.merchandise_urls) : [];
```

**è¯´æ˜**: 
- ä¼˜å…ˆä½¿ç”¨ `characterStatus`ï¼ˆæ¥è‡ªæ•°æ®åº“çš„æœ€æ–°çŠ¶æ€ï¼‰
- å¦‚æœ `characterStatus` ä¸å¯ç”¨ï¼Œåˆ™å›é€€åˆ° `ipCharacter`ï¼ˆprops æ•°æ®ï¼‰
- ç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„å‘¨è¾¹å•†å“æ•°æ®

## âœ… ä¿®å¤æ•ˆæœ

### å®Œæ•´çš„æ•°æ®æµ
1. **ä»»åŠ¡åˆ›å»º** â†’ ä»»åŠ¡çŠ¶æ€: 'pending'
2. **å¼€å§‹å¤„ç†** â†’ ä»»åŠ¡çŠ¶æ€: 'processing'
3. **ä»»åŠ¡å®Œæˆ** â†’ ä»»åŠ¡çŠ¶æ€: 'completed' + æ›´æ–°è§’è‰² `merchandise_urls`
4. **æ‰¹æ¬¡å®Œæˆ** â†’ è§’è‰²çŠ¶æ€: `merchandise_task_status: 'completed'`
5. **ç•Œé¢æ›´æ–°** â†’ å‘¨è¾¹å•†å“åˆ—è¡¨æ˜¾ç¤ºæ–°ç”Ÿæˆçš„å•†å“

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- âœ… **å®æ—¶æ˜¾ç¤º**: ç”Ÿæˆçš„å‘¨è¾¹å•†å“ç«‹å³æ˜¾ç¤ºåœ¨å·¥ä½œåŠä¸­
- âœ… **çŠ¶æ€åŒæ­¥**: ä»»åŠ¡çŠ¶æ€å’Œç•Œé¢æ˜¾ç¤ºä¿æŒåŒæ­¥
- âœ… **æ•°æ®æŒä¹…**: å‘¨è¾¹å•†å“æ•°æ®æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“
- âœ… **è®¡æ•°æ›´æ–°**: å‘¨è¾¹å•†å“æ ‡ç­¾é¡µæ˜¾ç¤ºæ­£ç¡®çš„æ•°é‡

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æµç¨‹
1. **åˆ›å»ºä»»åŠ¡**:
   - ç™»å½• â†’ å·¥ä½œåŠ â†’ é€‰æ‹©IP â†’ "é€‰æ‹©å•†å“"
   - é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªå•†å“ç±»å‹ â†’ "å¼€å§‹ç”Ÿæˆ"

2. **è§‚å¯ŸçŠ¶æ€å˜åŒ–**:
   - ä»»åŠ¡åˆ—è¡¨ï¼šä»»åŠ¡çŠ¶æ€ä»"ç­‰å¾…ä¸­" â†’ "å¤„ç†ä¸­" â†’ "å·²å®Œæˆ"
   - å·¥ä½œåŠï¼šå‘¨è¾¹å•†å“åŒºåŸŸä»ç©ºç™½åˆ°æ˜¾ç¤ºç”Ÿæˆçš„å•†å“

3. **éªŒè¯æ•°æ®æŒä¹…æ€§**:
   - åˆ·æ–°é¡µé¢ï¼Œå‘¨è¾¹å•†å“ä»ç„¶æ˜¾ç¤º
   - å‘¨è¾¹å•†å“æ ‡ç­¾é¡µæ˜¾ç¤ºæ­£ç¡®çš„æ•°é‡
   - å¯ä»¥é¢„è§ˆå’Œä¸‹è½½ç”Ÿæˆçš„å•†å“

### é¢„æœŸç»“æœ
- âœ… ä»»åŠ¡å®Œæˆåï¼Œå‘¨è¾¹å•†å“ç«‹å³æ˜¾ç¤ºåœ¨å·¥ä½œåŠä¸­
- âœ… å‘¨è¾¹å•†å“æ ‡ç­¾é¡µè®¡æ•°æ­£ç¡®æ›´æ–°
- âœ… ç”Ÿæˆçš„å•†å“å¯ä»¥é¢„è§ˆå’Œä¸‹è½½
- âœ… æ•°æ®åœ¨é¡µé¢åˆ·æ–°åä»ç„¶ä¿æŒ

## ğŸ“Š æŠ€æœ¯å®ç°ç»†èŠ‚

### æ•°æ®åº“æ›´æ–°
```sql
-- ä»»åŠ¡å®Œæˆæ—¶æ›´æ–°è§’è‰²è¡¨
UPDATE user_ip_characters 
SET merchandise_urls = jsonb_set(
  COALESCE(merchandise_urls, '{}'), 
  '{keychain}', 
  '"https://example.com/result.png"'
),
updated_at = NOW()
WHERE id = 'character_id';
```

### çŠ¶æ€ç®¡ç†
- **ä»»åŠ¡çº§åˆ«**: `generation_tasks.status` (pending â†’ processing â†’ completed)
- **è§’è‰²çº§åˆ«**: `user_ip_characters.merchandise_task_status` (null â†’ processing â†’ completed)
- **ç•Œé¢çº§åˆ«**: å®æ—¶è½®è¯¢è·å–æœ€æ–°çŠ¶æ€

### æ•°æ®åŒæ­¥
- **5ç§’è½®è¯¢**: IPDetail ç»„ä»¶æ¯5ç§’è·å–æœ€æ–°çŠ¶æ€
- **ä¼˜å…ˆçº§æ•°æ®**: ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“çŠ¶æ€ï¼Œå›é€€åˆ° props æ•°æ®
- **è‡ªåŠ¨æ›´æ–°**: ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ›´æ–°ç•Œé¢æ˜¾ç¤º

## ğŸ‰ ç”¨æˆ·ä»·å€¼

1. **å³æ—¶åé¦ˆ**: ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°ç”Ÿæˆçš„å‘¨è¾¹å•†å“
2. **å®Œæ•´ä½“éªŒ**: ä»é€‰æ‹©åˆ°æ˜¾ç¤ºçš„å®Œæ•´å·¥ä½œæµç¨‹
3. **æ•°æ®å¯é **: ç”Ÿæˆçš„å•†å“æ•°æ®æ­£ç¡®ä¿å­˜å’Œæ˜¾ç¤º
4. **ç•Œé¢ä¸€è‡´**: ä»»åŠ¡çŠ¶æ€å’Œå•†å“æ˜¾ç¤ºä¿æŒåŒæ­¥

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **å®æ—¶é€šçŸ¥**: æ·»åŠ ä»»åŠ¡å®Œæˆçš„å®æ—¶é€šçŸ¥
2. **é¢„è§ˆä¼˜åŒ–**: æ”¹è¿›å•†å“é¢„è§ˆå’Œä¸‹è½½ä½“éªŒ
3. **æ‰¹é‡ç®¡ç†**: æ”¯æŒæ‰¹é‡åˆ é™¤æˆ–é‡æ–°ç”Ÿæˆå•†å“
4. **åˆ†ç±»å±•ç¤º**: æŒ‰å•†å“ç±»å‹åˆ†ç±»æ˜¾ç¤º

---

**å¼€å‘æœåŠ¡å™¨**: http://localhost:3001  
**æµ‹è¯•æµç¨‹**: å·¥ä½œåŠ â†’ é€‰æ‹©IP â†’ é€‰æ‹©å•†å“ â†’ å¼€å§‹ç”Ÿæˆ â†’ æŸ¥çœ‹å‘¨è¾¹å•†å“æ ‡ç­¾é¡µ  
**çŠ¶æ€**: åŠŸèƒ½å®Œæ•´ï¼Œå‘¨è¾¹å•†å“æ­£å¸¸æ˜¾ç¤º âœ…

ç°åœ¨ç”Ÿæˆçš„å‘¨è¾¹å•†å“ä¼šæ­£ç¡®æ˜¾ç¤ºåœ¨å·¥ä½œåŠçš„å‘¨è¾¹å•†å“åˆ—è¡¨ä¸­ï¼
