# Supabase è®¤è¯ç³»ç»Ÿè¿ç§»æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®å·²ä»è‡ªå®šä¹‰ç”¨æˆ·è¡¨ç³»ç»Ÿè¿ç§»åˆ° Supabase Auth æ ‡å‡†è®¤è¯ç³»ç»Ÿï¼Œè§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ HTTP 406 é”™è¯¯ï¼ˆå¯†ç å“ˆå¸Œåœ¨URLä¸­ä¼ è¾“ï¼‰
- âŒ å®‰å…¨æ¼æ´ï¼ˆä¸å®‰å…¨çš„base64å¯†ç ç¼–ç ï¼‰  
- âŒ æ•°æ®åº“ç»“æ„ä¸åŒ¹é…ï¼ˆè‡ªå®šä¹‰usersè¡¨ vs auth.usersè¡¨ï¼‰
- âŒ RLSæƒé™é—®é¢˜

## ğŸ¯ è¿ç§»åçš„ä¼˜åŠ¿

- âœ… **å®‰å…¨è®¤è¯**: ä½¿ç”¨Supabaseå®˜æ–¹è®¤è¯ç³»ç»Ÿ
- âœ… **æ ‡å‡†åŒ–**: ç¬¦åˆç°ä»£Webåº”ç”¨æœ€ä½³å®è·µ
- âœ… **æƒé™æ§åˆ¶**: å®Œå–„çš„è¡Œçº§å®‰å…¨ç­–ç•¥
- âœ… **è‡ªåŠ¨ç®¡ç†**: ç”¨æˆ·ä¼šè¯å’Œä»¤ç‰Œè‡ªåŠ¨å¤„ç†
- âœ… **æ‰©å±•æ€§**: æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆé‚®ç®±ã€OAuthç­‰ï¼‰

## ğŸ› ï¸ æ•°æ®åº“è®¾ç½®

### æ–¹æ¡ˆ1: å…¨æ–°é¡¹ç›®ï¼ˆæ¨èï¼‰

å¦‚æœè¿™æ˜¯æ–°é¡¹ç›®æˆ–æ‚¨å¯ä»¥é‡ç½®æ•°æ®åº“ï¼š

1. åœ¨ Supabase Dashboard ä¸­è¿›å…¥ **SQL Editor**
2. å¤åˆ¶å¹¶æ‰§è¡Œ `database-setup-fresh.sql` æ–‡ä»¶å†…å®¹
3. æ•°æ®åº“å³å¯ä½¿ç”¨

### æ–¹æ¡ˆ2: ç°æœ‰é¡¹ç›®è¿ç§»

å¦‚æœæ‚¨æœ‰ç°æœ‰æ•°æ®éœ€è¦ä¿ç•™ï¼š

1. **å¤‡ä»½æ•°æ®**: å…ˆå¯¼å‡ºç°æœ‰æ•°æ®
2. **æ‰§è¡Œè¿ç§»**: åœ¨ SQL Editor ä¸­è¿è¡Œ `database-migration.sql`
3. **æ‰‹åŠ¨æ˜ å°„**: å°†æ—§ç”¨æˆ·æ•°æ®æ˜ å°„åˆ°æ–°çš„ auth.users
4. **æµ‹è¯•éªŒè¯**: ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

### æ–¹æ¡ˆ3: æ··åˆæ–¹å¼

1. å…ˆä½¿ç”¨ `database-setup-fresh.sql` åˆ›å»ºå…¨æ–°ç»“æ„
2. æ‰‹åŠ¨å¯¼å…¥é‡è¦çš„IPå½¢è±¡æ•°æ®
3. ç”¨æˆ·é‡æ–°æ³¨å†Œï¼ˆæ¨èï¼Œå› ä¸ºå¯†ç éœ€è¦é‡æ–°è®¾ç½®ï¼‰

## ğŸ“ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | ç”¨é€” | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `database-schema.sql` | å®Œæ•´çš„æ–°æ•°æ®åº“ç»“æ„ | å‚è€ƒå’Œæ–‡æ¡£ |
| `database-setup-fresh.sql` | å…¨æ–°é¡¹ç›®è®¾ç½® | æ–°é¡¹ç›®æˆ–å®Œå…¨é‡ç½® |
| `database-migration.sql` | ä»æ—§ç»“æ„è¿ç§» | ç°æœ‰é¡¹ç›®å‡çº§ |

## ğŸ”§ åº”ç”¨ä»£ç å˜æ›´

### è®¤è¯æ¥å£å˜æ›´

**æ—§æ¥å£ (å·²ç§»é™¤)**:
```typescript
interface User {
  id: string;
  username: string;
  password_hash: string;
  email?: string;
  created_at: string;
}
```

**æ–°æ¥å£**:
```typescript
interface AuthUser {
  id: string;                    // UUID from auth.users
  email?: string;
  username?: string;
  user_metadata?: {
    username?: string;
  };
  created_at: string;
}
```

### è®¤è¯å‡½æ•°å˜æ›´

**æ³¨å†Œ**:
```typescript
// æ—§æ–¹å¼ - ç›´æ¥æ’å…¥usersè¡¨
const user = await registerUser(username, password, email);

// æ–°æ–¹å¼ - ä½¿ç”¨Supabase Auth
const user = await registerUser(username, password, email);
// å†…éƒ¨ä½¿ç”¨: supabase.auth.signUp()
```

**ç™»å½•**:
```typescript
// æ—§æ–¹å¼ - æŸ¥è¯¢usersè¡¨ï¼ˆä¸å®‰å…¨ï¼‰
const user = await loginUser(username, password);

// æ–°æ–¹å¼ - ä½¿ç”¨Supabase Auth
const user = await loginUser(username, password);  
// å†…éƒ¨ä½¿ç”¨: supabase.auth.signInWithPassword()
```

**è·å–å½“å‰ç”¨æˆ·**:
```typescript
// æ–°å¢åŠŸèƒ½
const user = await getCurrentUser();
// å†…éƒ¨ä½¿ç”¨: supabase.auth.getUser()
```

## ğŸ” ç”¨æˆ·æ•°æ®å¤„ç†

### ç”¨æˆ·åå¤„ç†ç­–ç•¥

1. **æœ‰é‚®ç®±ç”¨æˆ·**: ç›´æ¥ä½¿ç”¨é‚®ç®±æ³¨å†Œ
2. **çº¯ç”¨æˆ·åç”¨æˆ·**: è‡ªåŠ¨ç”Ÿæˆ `${username}@temp.local` é‚®ç®±

### ç™»å½•ç­–ç•¥

1. è¾“å…¥åŒ…å« `@` â†’ ä½œä¸ºé‚®ç®±å¤„ç†
2. è¾“å…¥ä¸åŒ…å« `@` â†’ è½¬æ¢ä¸º `${username}@temp.local`

### æ•°æ®æ˜ å°„

```sql
-- ç”¨æˆ·æ•°æ®ç°åœ¨å­˜å‚¨åœ¨ auth.users è¡¨
-- ç”¨æˆ·åå­˜å‚¨åœ¨ raw_user_meta_data.username
-- é€šè¿‡ user_profiles è§†å›¾è½»æ¾è®¿é—®
SELECT * FROM user_profiles WHERE id = auth.uid();
```

## ğŸ›¡ï¸ å®‰å…¨æ”¹è¿›

### å¯†ç å®‰å…¨

- âŒ **æ—§æ–¹å¼**: Base64ç¼–ç ï¼ˆä¸å®‰å…¨ï¼‰
- âœ… **æ–°æ–¹å¼**: Supabaseæ ‡å‡†åŠ å¯†å“ˆå¸Œ

### ä¼ è¾“å®‰å…¨

- âŒ **æ—§æ–¹å¼**: å¯†ç å“ˆå¸Œåœ¨URLå‚æ•°ä¸­
- âœ… **æ–°æ–¹å¼**: æ‰€æœ‰æ•æ„Ÿæ•°æ®åœ¨è¯·æ±‚ä½“ä¸­

### æƒé™æ§åˆ¶

- âŒ **æ—§æ–¹å¼**: ä¾èµ–åº”ç”¨å±‚æƒé™æ§åˆ¶
- âœ… **æ–°æ–¹å¼**: æ•°æ®åº“çº§RLSæƒé™æ§åˆ¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

1. **æ³¨å†Œæ–°ç”¨æˆ·**
   ```typescript
   const user = await registerUser('testuser', 'password123');
   console.log('æ³¨å†ŒæˆåŠŸ:', user.id);
   ```

2. **ç”¨æˆ·ç™»å½•**
   ```typescript
   const user = await loginUser('testuser', 'password123');
   console.log('ç™»å½•æˆåŠŸ:', user.id);
   ```

3. **è·å–å½“å‰ç”¨æˆ·**
   ```typescript
   const user = await getCurrentUser();
   console.log('å½“å‰ç”¨æˆ·:', user?.username);
   ```

4. **åˆ›å»ºIPå½¢è±¡**
   ```typescript
   const character = await saveUserIPCharacter(
     user.id, 
     'æˆ‘çš„IPå½¢è±¡', 
     'https://example.com/image.jpg'
   );
   console.log('IPå½¢è±¡å·²ä¿å­˜:', character.id);
   ```

### æƒé™æµ‹è¯•

1. **RLSç­–ç•¥éªŒè¯**: ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®
2. **è·¨ç”¨æˆ·è®¿é—®**: ç¡®ä¿æ— æ³•è®¿é—®å…¶ä»–ç”¨æˆ·æ•°æ®
3. **åŒ¿åè®¿é—®**: ç¡®ä¿æœªç™»å½•ç”¨æˆ·æƒé™æ­£ç¡®

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"Invalid login credentials"é”™è¯¯**
   - åŸå› : ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯
   - è§£å†³: ç¡®ä¿ç”¨æˆ·å·²ä½¿ç”¨æ–°ç³»ç»Ÿæ³¨å†Œ

2. **"ç”¨æˆ·å·²å­˜åœ¨"é”™è¯¯**  
   - åŸå› : é‚®ç®±å·²è¢«æ³¨å†Œ
   - è§£å†³: ä½¿ç”¨ä¸åŒç”¨æˆ·åæˆ–é‚®ç®±

3. **æ•°æ®åº“æƒé™é”™è¯¯**
   - åŸå› : RLSç­–ç•¥é…ç½®é—®é¢˜
   - è§£å†³: æ£€æŸ¥å¹¶é‡æ–°æ‰§è¡Œæ•°æ®åº“è„šæœ¬

4. **UUIDç±»å‹é”™è¯¯**
   - åŸå› : æ—§æ•°æ®ç±»å‹ä¸åŒ¹é…
   - è§£å†³: ç¡®ä¿æ•°æ®åº“è¿ç§»å®Œæˆ

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**:
   ```typescript
   console.log('æ³¨å†Œç”¨æˆ·:', { username, email: email ? '[PROVIDED]' : '[NOT PROVIDED]' });
   ```

2. **æ£€æŸ¥Supabase Dashboard**:
   - Authentication â†’ Usersï¼šæŸ¥çœ‹æ³¨å†Œç”¨æˆ·
   - Database â†’ Tablesï¼šæ£€æŸ¥æ•°æ®ç»“æ„
   - Database â†’ Policiesï¼šéªŒè¯RLSç­–ç•¥

3. **ç½‘ç»œè¯·æ±‚æ£€æŸ¥**:
   - ç¡®ä¿æ²¡æœ‰ 406 é”™è¯¯
   - ç¡®è®¤è¯·æ±‚ä½¿ç”¨ POST è€Œé GET

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•

æ–°ç³»ç»ŸåŒ…å«ä¼˜åŒ–çš„ç´¢å¼•ï¼š
- `user_id` å­—æ®µç´¢å¼•ï¼ˆå¿«é€Ÿç”¨æˆ·æ•°æ®æŸ¥è¯¢ï¼‰
- `created_at` å­—æ®µç´¢å¼•ï¼ˆæ—¶é—´æ’åºæŸ¥è¯¢ï¼‰
- `status` å­—æ®µç´¢å¼•ï¼ˆä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ï¼‰

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- é«˜æ•ˆæŸ¥è¯¢ç”¨æˆ·IPå½¢è±¡
SELECT * FROM user_ip_characters 
WHERE user_id = auth.uid()
ORDER BY created_at DESC;

-- é«˜æ•ˆæŸ¥è¯¢ç”¨æˆ·ä»»åŠ¡
SELECT * FROM generation_tasks 
WHERE user_id = auth.uid() 
AND status = 'completed'
ORDER BY created_at DESC;
```

## ğŸ”„ ç»´æŠ¤æŒ‡å—

### å®šæœŸæ£€æŸ¥

1. **ç”¨æˆ·æ•°æ®å®Œæ•´æ€§**: æ£€æŸ¥ auth.users å’Œä¸šåŠ¡æ•°æ®çš„å…³è”
2. **æƒé™ç­–ç•¥**: å®šæœŸå®¡æŸ¥RLSç­–ç•¥æ˜¯å¦æ­£ç¡®
3. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

### å¤‡ä»½ç­–ç•¥

1. **è‡ªåŠ¨å¤‡ä»½**: é…ç½®Supabaseè‡ªåŠ¨å¤‡ä»½
2. **æ‰‹åŠ¨å¤‡ä»½**: é‡è¦æ“ä½œå‰æ‰‹åŠ¨å¤‡ä»½
3. **æµ‹è¯•æ¢å¤**: å®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤æµç¨‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Supabase Dashboard ä¸­çš„é”™è¯¯æ—¥å¿—
2. æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ç½‘ç»œå’Œæ§åˆ¶å°
3. æ•°æ®åº“è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®åº”ç”¨
4. RLSç­–ç•¥æ˜¯å¦æ­£ç¡®é…ç½®

è¿ç§»å®Œæˆåï¼Œç³»ç»Ÿå°†å…·å¤‡ä¼ä¸šçº§çš„å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ï¼ 