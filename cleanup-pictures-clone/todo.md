# IP形象生成和周边制作系统 - 待办事项

## 已完成功能 ✅

### 核心功能
- [x] IP形象生成（使用麻雀API的gpt-image-1模型）
- [x] 用户注册/登录系统
- [x] IP形象保存和管理
- [x] 图片上传到Supabase存储
- [x] 任务队列管理系统
- [x] 10秒轮询检查生成状态

### 周边商品生成 (已优化)
- [x] ✨ **2D周边图生成优化**: 现在必须同时使用"基础IP形象图"和"特定的周边商品提示词"作为输入
- [x] ✨ **提示词优化**: 为每种周边商品定制了专业的提示词描述
  - 钥匙扣: 适合小尺寸制作的简洁设计
  - 冰箱贴: 方形布局，温暖色彩
  - 手提袋: 时尚印花，居中图案
  - 手机壳: 适配长方形比例，考虑摄像头区域
- [x] ✨ **生成方式统一**: 与首页IP形象生成采用完全一致的gpt-image-1模型和API调用方式

### 3D模型生成 (已完善)
- [x] ✨ **多视图依赖**: 3D模型生成必须在"左视图"和"后视图"全部生成完毕后才开始
- [x] ✨ **三视图输入**: 将"正面图"、"左视图"、"后视图"三张图一起提交给Tripo3D API
- [x] ✨ **严格验证**: 添加了完整的视图检查逻辑，确保所有必需图片都已准备就绪
- [x] 多视图生成（左视图、后视图）
- [x] 集成Tripo3D API进行3D建模

### 任务管理
- [x] ✨ **任务重试功能**: 新增 `/api/tasks/[taskId]/retry` 端点
- [x] ✨ **重试按钮**: 任务列表中失败的任务现在显示重试按钮
- [x] ✨ **错误处理优化**: 改进了API超时和连接错误的处理
- [x] 任务状态实时更新
- [x] 批量任务处理

## 技术改进 ✅

### API优化
- [x] ✨ **周边生成API**: 优化了 `triggerSparrowGeneration` 函数，确保必须提供基础IP形象图
- [x] ✨ **错误处理**: 增强了错误信息的详细程度和用户友好性
- [x] ✨ **提示词专业化**: 每种商品类型都有专门的设计要求描述
- [x] 图片压缩和优化
- [x] Base64和URL格式支持

### 数据库
- [x] 修复了RLS策略问题
- [x] 修复了外键约束问题
- [x] 添加了缺失的任务类型约束
- [x] 性能优化索引

## 当前问题 ⚠️

### 外部API稳定性
- [ ] Sparrow API连接超时频繁发生
- [ ] Tripo3D API参数验证错误需要调试
- [ ] 需要添加更好的重试机制和回退策略

### 用户体验
- [ ] 任务失败后UI状态管理需要优化
- [ ] 需要更好的进度指示器
- [ ] 批量操作的用户反馈需要改进

## 下一步计划 📋

### 高优先级
1. **调试外部API问题**
   - 分析Sparrow API超时的根本原因
   - 检查Tripo3D API参数格式
   - 实现API健康检查

2. **UI/UX优化**
   - 改进任务失败时的状态保持
   - 添加更详细的进度反馈
   - 优化移动端体验

3. **稳定性改进**
   - 添加API重试机制
   - 实现降级策略
   - 改进错误恢复

### 中优先级
- [ ] 添加任务批量操作功能
- [ ] 实现任务历史记录
- [ ] 优化数据库查询性能
- [ ] 添加缓存机制

### 低优先级
- [ ] 添加更多周边商品类型
- [ ] 实现高级自定义选项
- [ ] 添加社交分享功能
- [ ] 实现用户作品展示

## 技术债务
- [ ] 统一错误处理机制
- [ ] 改进类型定义
- [ ] 添加单元测试
- [ ] 优化代码结构

---

**最新更新**: 2024年12月19日
- ✨ 完成2D周边生成优化，确保同时使用基础IP形象图和特定提示词
- ✨ 完善3D模型生成流程，实现三视图统一提交
- ✨ 添加任务重试功能，改善用户体验
- ✨ 优化提示词质量，提升生成效果

**核心原则**: 
1. 2D周边图生成必须同时使用"基础IP形象图"和"特定的周边商品提示词"
2. 3D模型生成必须在"左视图"和"后视图"全部完成后，将"正、左、后"三张图一起提交
3. 与首页IP形象生成保持完全一致的gpt-image-1模型使用方式 